# 상관 분석

## 상관 분석 

상관 분석(Correlation Analysis)은 두 연속형 변수 간의 **관계의 방향과 강도**를 수치로 표현하는 방법이다. **인과관계를 의미하지는 않는다**.

## 상관계수 기본 개념

* 값의 범위: **-1 ~ +1**
* 해석

  * +1: 완전한 양의 상관
  * 0: 선형 관계 없음
  * -1: 완전한 음의 상관

### 주의사항

* 상관관계 ≠ 인과관계
* 이상치에 민감할 수 있음
* 관계가 비선형이면 값이 작게 나올 수 있음

## Pearson 상관 분석

### 개념

* **선형(linear) 관계** 측정
* 평균과 분산을 기반으로 계산
* 정규성 가정이 비교적 중요

### 사용 조건

* 연속형 변수
* 선형 관계
* 극단값이 많지 않음

### 가설 설정

* H₀: 두 변수 간 선형 상관이 없다 (ρ = 0)
* H₁: 두 변수 간 선형 상관이 있다 (ρ ≠ 0)

### 예제

#### 분석 목표

* 부리 길이(bill_length_mm)와 부리 깊이(bill_depth_mm) 사이의 관계

```{python}
import seaborn as sns
from scipy.stats import pearsonr

df = sns.load_dataset("penguins")

x = df["bill_length_mm"]
y = df["bill_depth_mm"]

df_corr = df[["bill_length_mm", "bill_depth_mm"]].dropna()
```

#### Pearson 상관계수 계산

```{python}
r, p_value = pearsonr(
    df_corr["bill_length_mm"],
    df_corr["bill_depth_mm"]
)

r, p_value
```

### 결과 해석

* r > 0

  * 양의 선형 관계
* |r|가 클수록

  * 관계가 강함
* p-value < 0.05

  * 상관관계가 통계적으로 유의함

## Spearman 순위 상관 분석

### 개념

* **순위(rank)** 기반 상관 분석
* 비선형이지만 **단조(monotonic)** 관계면 탐지 가능
* 비모수적 방법

### 언제 사용하는가?

* 정규성 가정이 깨졌을 때
* 이상치가 많은 경우
* 값의 크기보다 **순서**가 중요할 때

### 가설 설정

* H₀: 두 변수 간 순위 상관이 없다
* H₁: 두 변수 간 순위 상관이 있다

### 예제

```{python}
from scipy.stats import spearmanr

rho, p_value = spearmanr(
    df_corr["bill_length_mm"],
    df_corr["bill_depth_mm"]
)

rho, p_value
```

### Pearson vs Spearman 비교

| 항목     | Pearson | Spearman |
| ------ | ------- | -------- |
| 기반     | 실제 값    | 순위       |
| 관계 형태  | 선형      | 단조       |
| 이상치 영향 | 큼       | 작음       |
| 정규성    | 중요      | 덜 중요     |


## 상관 행렬(Correlation Matrix)

### 여러 변수 간 관계 한 번에 보기

```{python}
num_cols = [
    "bill_length_mm",
    "bill_depth_mm",
    "flipper_length_mm",
    "body_mass_g"
]

corr_matrix = df[num_cols].corr(method="pearson")
corr_matrix
```

### 시각화

```{python}
import seaborn as sns
import matplotlib.pyplot as plt

sns.heatmap(
    corr_matrix,
    annot=True,
    cmap="coolwarm",
    fmt=".2f"
)

plt.title("Correlation Matrix of Penguins")
plt.show()
```

## 해석 팁

* 상관계수 절대값 기준(경험적)

  * 0.1 ~ 0.3: 약함
  * 0.3 ~ 0.5: 중간
  * 0.5 이상: 강함
* 항상 산점도와 함께 확인
* 상관이 높다고 변수 제거를 바로 결정하지 말 것


## 정리

* Pearson

  * 선형 관계 분석의 기본
* Spearman

  * 분포·이상치에 강한 대안
* 상관 분석은

  * EDA
  * 피처 선택
  * 회귀 모델링의 출발점

## Kendall 순위 상관 
Kendall 순위 상관(Kendall’s τ)은 순위 기반 상관 분석 방법이다.

### 개념

* **순위 기반 상관 분석**
* Spearman과 유사하지만 계산 방식이 다름
* 두 변수의 **순위 쌍이 얼마나 일관되게 증가/감소하는지** 측정

### 직관적 설명

* 관측치 쌍 (xᵢ, yᵢ), (xⱼ, yⱼ)에 대해

  * x와 y가 **같은 방향으로 증가/감소** → concordant
  * 방향이 다르면 → discordant
* Kendall τ는

  * (일치 쌍 − 불일치 쌍) / 전체 쌍

**“순서가 얼마나 자주 같은 방향으로 움직이는가?”**

### 값의 범위

* -1 ~ +1
* Spearman보다 절댓값이 **작게 나오는 경향**
* 대신 해석은 더 보수적이고 안정적

### 언제 사용하는가?

* 표본 수가 작을 때
* 동일 값(ties)이 많을 때
* 순서 정보가 매우 중요한 경우
* 비선형 + 단조 관계

### 예제

```{python}
from scipy.stats import kendalltau

tau, p_value = kendalltau(
    df_corr["bill_length_mm"],
    df_corr["bill_depth_mm"]
)

tau, p_value
```

### 해석

* τ > 0

  * 순위가 함께 증가하는 경향
* p-value < 0.05

  * 순위 상관이 통계적으로 유의함

## Pearson · Spearman · Kendall 비교 정리

| 구분     | Pearson | Spearman | Kendall |
| ------ | ------- | -------- | ------- |
| 기반     | 실제 값    | 순위       | 순위 쌍    |
| 관계 형태  | 선형      | 단조       | 단조      |
| 이상치 영향 | 큼       | 중간       | 작음      |
| 정규성 필요 | 높음      | 낮음       | 낮음      |
| 값 크기   | 가장 큼    | 중간       | 가장 작음   |
| 해석 안정성 | 낮음      | 중간       | 높음      |
