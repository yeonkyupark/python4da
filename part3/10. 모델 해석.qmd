# ëª¨ë¸ í•´ì„

## ì™œ ëª¨ë¸ í•´ì„ì´ í•„ìš”í•œê°€

ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì€ ì ì  ë³µì¡í•´ì§€ê³  ìˆë‹¤. í•˜ì§€ë§Œ ì‹¤ë¬´ì—ì„œëŠ” ë‹¤ìŒ ì§ˆë¬¸ì— ë‹µí•´ì•¼ í•œë‹¤.

* ì–´ë–¤ ë³€ìˆ˜ê°€ ê°€ì¥ ì¤‘ìš”í•œê°€?
* íŠ¹ì • ì˜ˆì¸¡ì€ ì™œ ì´ë ‡ê²Œ ë‚˜ì™”ëŠ”ê°€?
* ëª¨ë¸ì´ í¸í–¥ë˜ì–´ ìˆì§€ëŠ” ì•Šì€ê°€?

ğŸ‘‰ **ëª¨ë¸ í•´ì„(Model Interpretation)ì€ ì„ íƒì´ ì•„ë‹ˆë¼ í•„ìˆ˜**

## ëª¨ë¸ í•´ì„ì˜ ë²”ì£¼

ëª¨ë¸ í•´ì„ì€ í¬ê²Œ ë‘ ê°€ì§€ ê´€ì ìœ¼ë¡œ ë‚˜ë‰œë‹¤.

| êµ¬ë¶„    | ì„¤ëª…                   |
| ----- | -------------------- |
| ì „ì—­ í•´ì„ | ëª¨ë¸ ì „ì²´ì—ì„œ ì¤‘ìš”í•œ ë³€ìˆ˜ëŠ” ë¬´ì—‡ì¸ê°€ |
| êµ­ì†Œ í•´ì„ | ê°œë³„ ìƒ˜í”Œì˜ ì˜ˆì¸¡ ì´ìœ          |

## íŠ¹ì„± ì¤‘ìš”ë„ 

### ê°œë…

íŠ¹ì„± ì¤‘ìš”ë„(Feature Importance)ëŠ” **ëª¨ë¸ì´ ì˜ˆì¸¡ì— ì–¼ë§ˆë‚˜ í•´ë‹¹ ë³€ìˆ˜ë¥¼ í™œìš©í–ˆëŠ”ì§€**ë¥¼ ìˆ˜ì¹˜ë¡œ í‘œí˜„í•œ ê²ƒì´ë‹¤. ì£¼ë¡œ íŠ¸ë¦¬ ê¸°ë°˜ ëª¨ë¸ì—ì„œ ì œê³µëœë‹¤.

## íŠ¸ë¦¬ ê¸°ë°˜ ëª¨ë¸ì˜ íŠ¹ì„± ì¤‘ìš”ë„

### penguins ë°ì´í„° ì¤€ë¹„

```{python}
from palmerpenguins import load_penguins
import pandas as pd

df = load_penguins().dropna()

X = df[[
    "bill_length_mm",
    "bill_depth_mm",
    "flipper_length_mm",
    "body_mass_g"
]]
y = df["species"]
```

### RandomForest í•™ìŠµ

```{python}
from sklearn.ensemble import RandomForestClassifier

rf = RandomForestClassifier(
    n_estimators=200,
    random_state=42
)

rf.fit(X, y)
```

### íŠ¹ì„± ì¤‘ìš”ë„ í™•ì¸

```{python}
import pandas as pd

importance = pd.Series(
    rf.feature_importances_,
    index=X.columns
).sort_values(ascending=False)

importance
```

### í•´ì„ í¬ì¸íŠ¸

* ê°’ì´ í´ìˆ˜ë¡ ëª¨ë¸ ë¶„ê¸°ì—ì„œ ìì£¼ ì‚¬ìš©ë¨
* **ì¸ê³¼ ê´€ê³„ëŠ” ì•„ë‹˜**
* ë³€ìˆ˜ ê°„ ìƒê´€ì„±ì´ ìˆìœ¼ë©´ ì™œê³¡ ê°€ëŠ¥

## Permutation Importance 

### ê°œë…

* íŠ¹ì • ë³€ìˆ˜ë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ì—ˆì„ ë•Œ
* ì„±ëŠ¥ì´ ì–¼ë§ˆë‚˜ ë–¨ì–´ì§€ëŠ”ì§€ ì¸¡ì •

ëª¨ë¸ ì¢…ë¥˜ì— ìƒê´€ì—†ì´ ì‚¬ìš© ê°€ëŠ¥

### ì˜ˆì œ

```{python}
from sklearn.inspection import permutation_importance

result = permutation_importance(
    rf,
    X,
    y,
    n_repeats=10,
    random_state=42
)

perm_importance = pd.Series(
    result.importances_mean,
    index=X.columns
).sort_values(ascending=False)

perm_importance
```

**ì‹¤ë¬´ì—ì„œëŠ” ê¸°ë³¸ feature_importanceë³´ë‹¤ ì‹ ë¢°ë„ ë†’ìŒ**

## SHAP ê°œìš”

shapëŠ” Python 3.6 ~ 3.10ì—ì„œ ì§€ì›í•œë‹¤. ì´ì™¸ ë²„ì „ì¸ ê²½ìš° ëŒ€ì²´, ë³´ì™„ ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.

### SHAP (SHapley Additive exPlanations)

* ê²Œì„ ì´ë¡  ê¸°ë°˜
* ê° íŠ¹ì„±ì´ ì˜ˆì¸¡ê°’ì— ê¸°ì—¬í•œ ì •ë„ë¥¼ ê³„ì‚°
* ì „ì—­ + êµ­ì†Œ í•´ì„ ëª¨ë‘ ê°€ëŠ¥

**í˜„ì¬ ê°€ì¥ í‘œì¤€ì ì¸ ëª¨ë¸ í•´ì„ ë°©ë²•**

## SHAP ê°’ì˜ í•µì‹¬ ê°œë…

* ê¸°ì¤€ê°’(base value)ì—ì„œ ì¶œë°œ
* ê° íŠ¹ì„±ì´ ì˜ˆì¸¡ê°’ì„ ì–¼ë§ˆë‚˜ ë°€ì—ˆëŠ”ì§€
* ëª¨ë“  ê¸°ì—¬ë„ì˜ í•© = ìµœì¢… ì˜ˆì¸¡

## SHAP ì ìš© (Tree ê¸°ë°˜)

```python
import shap

explainer = shap.TreeExplainer(rf)
shap_values = explainer.shap_values(X)
```

### ì „ì—­ í•´ì„ â€“ Summary Plot

```python
shap.summary_plot(
    shap_values,
    X,
    plot_type="bar"
)
```

ì˜ë¯¸

* ì „ì²´ ëª¨ë¸ì—ì„œ ì¤‘ìš”í•œ ë³€ìˆ˜ ìˆœìœ„
* ë°©í–¥ì„±ì€ ì•Œ ìˆ˜ ì—†ìŒ (ë§‰ëŒ€í˜•)

### ë¶„í¬ ê¸°ë°˜ Summary Plot

```python
shap.summary_plot(
    shap_values,
    X
)
```

í•´ì„ í¬ì¸íŠ¸

* ìƒ‰ìƒ: íŠ¹ì„± ê°’ í¬ê¸°
* ìœ„ì¹˜: ì˜ˆì¸¡ì— ë¯¸ì¹œ ì˜í–¥ ë°©í–¥
* ë³€ìˆ˜ë³„ ì˜í–¥ ë¶„í¬ í™•ì¸ ê°€ëŠ¥

## ê°œë³„ ì˜ˆì¸¡ í•´ì„ (Local Explanation)

### íŠ¹ì • ìƒ˜í”Œ ì„ íƒ

```python
i = 0
```

### Force Plot

```python
shap.force_plot(
    explainer.expected_value[0],
    shap_values[0][i],
    X.iloc[i]
)
```

â€œì´ í­ê·„ì´ ì™œ ì´ ì¢…ìœ¼ë¡œ ë¶„ë¥˜ëëŠ”ì§€â€ ì„¤ëª… ê°€ëŠ¥

## SHAP ì‚¬ìš© ì‹œ ì£¼ì˜ì  

* ê³„ì‚° ë¹„ìš© í¼
* ë°ì´í„° í¬ê¸° í´ ê²½ìš° ìƒ˜í”Œë§ í•„ìš”
* ëª¨ë¸ êµ¬ì¡°ì— ë”°ë¼ explainer ì„ íƒ

| ëª¨ë¸      | Explainer       |
| ------- | --------------- |
| Tree ëª¨ë¸ | TreeExplainer   |
| ì¼ë°˜ ëª¨ë¸   | KernelExplainer |

## íŠ¹ì„± ì¤‘ìš”ë„ vs SHAP ë¹„êµ

| í•­ëª©    | íŠ¹ì„± ì¤‘ìš”ë„ | SHAP |
| ----- | ------ | ---- |
| ì „ì—­ í•´ì„ | ê°€ëŠ¥     | ê°€ëŠ¥   |
| êµ­ì†Œ í•´ì„ | ë¶ˆê°€     | ê°€ëŠ¥   |
| ë°©í–¥ì„±   | ë¶ˆê°€     | ê°€ëŠ¥   |
| ê³„ì‚° ë¹„ìš© | ë‚®ìŒ     | ë†’ìŒ   |

## ì •ë¦¬

* **ëª¨ë¸ ì„±ëŠ¥ë§Œ ë³´ê³  ëë‚´ì§€ ë§ ê²ƒ**
* ì˜ì‚¬ê²°ì • ëª¨ë¸ì€ ë°˜ë“œì‹œ í•´ì„ í¬í•¨
* ë³´ê³ ì„œì—ëŠ” SHAP ì‹œê°í™” ì ê·¹ í™œìš©

## Python 3.12 ê¸°ì¤€ ëª¨ë¸ í•´ì„

Python 3.12 í™˜ê²½ì—ì„œëŠ” SHAP ëŒ€ì‹  **Permutation Importance + PDP** ì¡°í•©ì„ ì‚¬ìš©í•œë‹¤.

### Permutation Importance (ì „ì—­ ì¤‘ìš”ë„)

#### ê°œë…

íŠ¹ì • ë³€ìˆ˜ë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ì—ˆì„ ë•Œ**ëª¨ë¸ ì„±ëŠ¥ì´ ì–¼ë§ˆë‚˜ ê°ì†Œí•˜ëŠ”ì§€**ë¡œ ì¤‘ìš”ë„ë¥¼ íŒë‹¨í•œë‹¤. 

#### ì–¸ì œ ì“°ë‚˜

ëª¨ë¸ì´ **ì–´ë–¤ ë³€ìˆ˜ë¥¼ ì‹¤ì œë¡œ ì˜ì¡´í•˜ëŠ”ì§€** ì•Œê³  ì‹¶ì„ ë•Œ íŠ¸ë¦¬Â·SVMÂ·ì•™ìƒë¸” ë“± **ëª¨ë¸ ì¢…ë¥˜ ë¬´ê´€**í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

#### ì˜ˆì œ 

```{python}
from palmerpenguins import load_penguins
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.inspection import permutation_importance
import pandas as pd

df = load_penguins().dropna()

X = df[['bill_length_mm', 'bill_depth_mm',
        'flipper_length_mm', 'body_mass_g']]
y = df['species']

X_train, X_test, y_train, y_test = train_test_split(
    X, y, random_state=42
)

model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

result = permutation_importance(
    model, X_test, y_test,
    n_repeats=10, random_state=42
)

perm_importance = pd.Series(
    result.importances_mean,
    index=X.columns
).sort_values(ascending=False)

perm_importance
```

#### í•´ì„ í¬ì¸íŠ¸

* ê°’ì´ í´ìˆ˜ë¡ **ì˜ˆì¸¡ ì„±ëŠ¥ì— ì¤‘ìš”í•œ ë³€ìˆ˜**
* â€œëª¨ë¸ì´ ì‹¤ì œë¡œ ì“°ëŠ” ë³€ìˆ˜â€ë¥¼ ë³´ì—¬ì¤Œ

### Partial Dependence Plot (PDP)

#### ê°œë…

íŠ¹ì • ë³€ìˆ˜ê°€ ë³€í•  ë•Œ **ì˜ˆì¸¡ê°’ì´ í‰ê· ì ìœ¼ë¡œ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€** ì‹œê°í™”í•œë‹¤.

#### ì–¸ì œ ì“°ë‚˜

ë³€ìˆ˜ì˜ **ì˜í–¥ ë°©í–¥(+/âˆ’)**ì„ ì•Œê³  ì‹¶ì„ ë•Œ, ì „ì—­ì ì¸ ê²½í–¥ ì„¤ëª…ìš©ìœ¼ë¡œ ì í•©í•˜ë‹¤.

#### ì˜ˆì œ

```{python}
from sklearn.inspection import PartialDependenceDisplay
import matplotlib.pyplot as plt

PartialDependenceDisplay.from_estimator(
    model,
    X_train,
    features=['flipper_length_mm', 'body_mass_g'],
    target='Gentoo'
)

plt.show()
```

### í•´ì„ í¬ì¸íŠ¸

* â€œë‚ ê°œ ê¸¸ì´ê°€ ì¦ê°€í• ìˆ˜ë¡ íŠ¹ì • ì¢…ìœ¼ë¡œ ë¶„ë¥˜ë  í™•ë¥ ì´ ì¦ê°€â€
* í‰ê·  íš¨ê³¼ â†’ ê°œë³„ ìƒ˜í”Œ ì„¤ëª…ì€ ì•„ë‹˜


## ì •ë¦¬

* Permutation Importance

  * ë¬´ì—‡ì´ ì¤‘ìš”í•œê°€ (ì „ì—­)
* PDP

  * ì–´ë–»ê²Œ ì˜í–¥ì„ ì£¼ëŠ”ê°€ (ë°©í–¥Â·í˜•íƒœ)

